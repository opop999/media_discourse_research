---
title: "Exploratory data analysis"
---

Load necessary packages
```{r include=FALSE}
# Package names
packages <- c("dplyr", "stringr", "purrr", "tidyr", "tidytext", "ggplot2", "plotly", "forcats", "cluster", "NbClust")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

# Turn off scientific notation
options(scipen = 999)

# Import media labels
media_labels <- readRDS("../1.data_sources/media_articles/data/media_type_labels/all_media_labels_with_doc_id.rds")

```


```{r include=FALSE}

# Data time limits
start_date <- as.Date("2015-01-01")
end_date <- as.Date("2023-03-01")

graph_settings <- list(dates = c(as.Date("2015-05-11"),
                        as.Date("2015-09-02"),
                        as.Date("2016-09-21"),
                        as.Date("2016-11-03"),
                        as.Date("2018-01-27"),
                        as.Date("2018-06-10"),
                        as.Date("2019-01-01"),
                        as.Date("2020-03-11"),
                        as.Date("2022-02-24")),
# Original short descriptions and graph adjustments for the graphs
                      # events = c("EU quota",
                      #   "Alan Kurdi",
                      #   "Egypt shipwreck",
                      #   "Libya shipwreck",
                      #   "Milos Zeman re-elected",
                      #   "Aquarius rejected",
                      #   "Lowest 5yr arrivals",
                      #   "Pandemic start",
                      #   "Invasion of Ukraine"),
                      # color_graph_adjust = c(
                      #   -22,
                      #   -27,
                      #   -23,
                      #   -18,
                      #   -24,
                      #   -30,
                      #   -21,
                      #   -15,
                      #   -54
                      # ),
                      # bw_graph_adjust = c(
                      #   -22,
                      #   -40,
                      #   -40,
                      #   -46,
                      #   -61,
                      #   -46,
                      #   -35,
                      #   -22,
                      #   -23
                      # )
# Extended description text after peer-review feedback on article
events = c(
  "EU Commission \n proposes refugee \nquotas",
  "Alan Kurdi \ndrowns in the \nMediterranean Sea",
  "Egypt shipwreck \nkills hundreds",
  "Two shipwrecks \noff Libyan \ncoast",
  "Czech Republic \nre-elects \nMiloš Zeman \nas president",
  "Italy and Malta\n deny entry \nto NGO ship\n Aquarius",
  "EU reports \nlowest number \nof migrant arrivals \nin five years",
  "Covid-19 pandemic\n declared",
  "Russia invades\n Ukraine"
), 
                      color_graph_adjust = c(
                        -2,
                        -7,
                        -3,
                        -8,
                        -4,
                        -2,
                        -1,
                        -5,
                        -7
                      ),
                      bw_graph_adjust = c(
                        -5,
                        -10,
                        -13,
                        -11,
                        -8,
                        -6,
                        -4,
                        -6,
                        -9
                      ),
color_graph_txt_size = 1.3,
bw_graph_txt_size = 1.6
                      )
```

# Step 1: Analysis of Migration News frequency 2015-2022

## Step 1.1

```{r}
annotated_articles <- list.files(path = "../1.data_sources/media_articles/data/annotations/chunks/",
                                  pattern = "*.rds",
                                  full.names = TRUE) %>%
                      map_dfr(readRDS)

all_content_counts <- readRDS("../1.data_sources/media_articles/data/counts/media_count_df_by_1_month.rds")
```

What it the total published content (beyond just migration coverage) of the media in our sample?

```{r}
print(paste("Between", min(all_content_counts$period_start), "and", max(all_content_counts$period_end), "the", length(unique(all_content_counts$searched_name)), "media outlets in our sample published", sum(all_content_counts$count)/1000000, "million articles"))
```

Proportions of migration content: per media
```{r}
# Summarize the migration content per month and all content per month
migration_articles_per_month <- annotated_articles %>%
  mutate(month = as.Date(cut(as.Date(datePublished), breaks = "month"))) %>%
  filter(month <= end_date) %>% 
  count(month, name = "migration_count")

all_articles_per_month <- all_content_counts %>%
  mutate(month = as.Date(period_start)) %>%
  filter(month <= end_date) %>% 
  group_by(month) %>%
  summarize(all_count = sum(count))

combined_counts <- inner_join(migration_articles_per_month, all_articles_per_month, by = "month") %>% 
  mutate(migration_prop = (migration_count/all_count))

# Save data where each row is a month and we get all content/migration content and proportion info
saveRDS(combined_counts, "data/counts/combined_counts.rds")
```

Proportions of migration content: per month and selected media type
```{r}
# Summarize the migration content per month and all content per month
migration_articles_per_month_media_grouped <- annotated_articles %>%
  mutate(month = as.Date(cut(as.Date(datePublished), breaks = "month"))) %>%
  inner_join(media_labels, by = c("code" = "doc_id"))  %>%  # Optional for grouping on media type
  filter(month <= end_date,
         media_type %in% c("mainstream", "antisystem", "political_tabloid")) %>% 
  mutate(media_type = fct_collapse(media_type, alternative = c("antisystem", "political_tabloid"))) %>% 
  group_by(month, media_type) %>%
  summarize(migration_count = n())

all_articles_per_month_media_grouped <- all_content_counts %>%
  mutate(month = as.Date(period_start),
         media_id = as.integer(id)) %>% 
  inner_join(distinct(media_labels, media_id,.keep_all = TRUE), by = "media_id") %>%  
  filter(month <= end_date,
         media_type %in% c("mainstream", "antisystem", "political_tabloid")) %>%
  mutate(media_type = fct_collapse(media_type, alternative = c("antisystem", "political_tabloid"))) %>% 
  group_by(month, media_type) %>%
  summarize(all_count = sum(count))

combined_counts_grouped <- inner_join(migration_articles_per_month_media_grouped, all_articles_per_month_media_grouped, by = c("month", "media_type")) %>% 
  mutate(migration_prop = (migration_count/all_count))

saveRDS(combined_counts_grouped, "data/counts/combined_counts_grouped.rds")

# What is the average proportion
combined_counts_grouped %>% 
  group_by(media_type) %>% 
  summarise(mean_prop = mean(migration_prop),
            weight_mean = weighted.mean(migration_prop, all_count),
            weight_sd = Hmisc::wtd.var(migration_prop, migration_count))

```

Proportions of migration content: per media and month
```{r}
# Summarize the migration content per media per month
migration_articles_per_media_and_month <- annotated_articles %>%
  mutate(month = as.Date(cut(as.Date(datePublished), breaks = "month"))) %>%
  filter(month <= end_date) %>% 
  count(month, sourceName, name = "migration_count")

# Summarize the overall content per media per month
all_articles_per_media_and_month <- all_content_counts %>%
  mutate(month = as.Date(period_start)) %>%
  filter(month <= end_date) %>% 
  group_by(month, searched_name) %>%
  summarize(all_count = sum(count))

combined_counts_per_media_and_month <-
  inner_join(
    all_articles_per_media_and_month,
    migration_articles_per_media_and_month,
    by = c("month" = "month", "searched_name" = "sourceName")
  ) %>%
  filter(migration_count <= all_count) %>%
  mutate(migration_prop = migration_count / all_count)

# Save data where each row is a month for each media
saveRDS(combined_counts_per_media_and_month, "data/counts/combined_counts_media_month.rds")

```

## Step 1.2: Visualization

```{r}
# GRAPH 1: ALL migration content, 2015-2022
combined_counts %>% 
  ggplot(aes(x = month)) +
  geom_col(aes(y = migration_count), fill = "#3db5ff") +
  geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), color = "#563a3a", linetype = 2, linewidth = 0.2) +
  geom_text(aes(x = graph_settings$dates[1], y = 0, label = graph_settings$events[1]), color = "#22209F", vjust = graph_settings$color_graph_adjust[1], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[2], y = 0, label = graph_settings$events[2]), color = "#22209F", vjust = graph_settings$color_graph_adjust[2], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[3], y = 0, label = graph_settings$events[3]), color = "#22209F", vjust = graph_settings$color_graph_adjust[3], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[4], y = 0, label = graph_settings$events[4]), color = "#22209F", vjust = graph_settings$color_graph_adjust[4], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[5], y = 0, label = graph_settings$events[5]), color = "#22209F", vjust = graph_settings$color_graph_adjust[5], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[6], y = 0, label = graph_settings$events[6]), color = "#22209F", vjust = graph_settings$color_graph_adjust[6], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[7], y = 0, label = graph_settings$events[7]), color = "#22209F", vjust = graph_settings$color_graph_adjust[7], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[8], y = 0, label = graph_settings$events[8]), color = "#22209F", vjust = graph_settings$color_graph_adjust[8], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[9], y = 0, label = graph_settings$events[9]), color = "#22209F", vjust = graph_settings$color_graph_adjust[9], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  ylab("Articles count (in thousand)") +
  xlab(element_blank()) +
  labs(title = "Migration Articles in the Czech News Media: 2015-2022",
       subtitle = "Per month articles collected with the migration search string",
       caption = "Data: Newton Media Archive, Search string: běženec* OR běženk* OR imigrant* OR migra* OR imigra* OR přistěhoval* OR uprchl* OR utečen* OR azylant*") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 4.5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_y_continuous(
    expand = c(0, 0),
    breaks = seq(0, 100000, 5000),
    labels = seq(0, 100, 5),
    limits = c(0, max(combined_counts$migration_count) + 10000)
  )

ggsave("../5.write_up/presentation_CCL_march_2022/graphics/all_migration_content.png", device = "png",
       width = 1920, height = 1080, units = "px")

```

```{r}
# GRAPH 2: Proportion of migration content thorough time, all media, 2015-2022
combined_counts %>% 
  ggplot(aes(x = month, y = migration_prop)) +
  geom_line(color = "#3db5ff") +
  geom_point(color = "#3db5ff", size = 0.5) +
  geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), color = "#563a3a", linetype = 2, linewidth = 0.2) +
  geom_text(aes(x = graph_settings$dates[1], y = 0, label = graph_settings$events[1]), color = "#22209F", vjust = graph_settings$color_graph_adjust[1], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[2], y = 0, label = graph_settings$events[2]), color = "#22209F", vjust = graph_settings$color_graph_adjust[2], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[3], y = 0, label = graph_settings$events[3]), color = "#22209F", vjust = graph_settings$color_graph_adjust[3], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[4], y = 0, label = graph_settings$events[4]), color = "#22209F", vjust = graph_settings$color_graph_adjust[4], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[5], y = 0, label = graph_settings$events[5]), color = "#22209F", vjust = graph_settings$color_graph_adjust[5], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[6], y = 0, label = graph_settings$events[6]), color = "#22209F", vjust = graph_settings$color_graph_adjust[6], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[7], y = 0, label = graph_settings$events[7]), color = "#22209F", vjust = graph_settings$color_graph_adjust[7], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[8], y = 0, label = graph_settings$events[8]), color = "#22209F", vjust = graph_settings$color_graph_adjust[8], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[9], y = 0, label = graph_settings$events[9]), color = "#22209F", vjust = graph_settings$color_graph_adjust[9], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  labs(title = "Proportion of Migration Content in the Czech News Media: 2015-2022",
       subtitle = "Percent of overall publishing output aggregated by month",
       caption = "Data: Newton Media Archive, Search string: běženec* OR běženk* OR imigrant* OR migra* OR imigra* OR přistěhoval* OR uprchl* OR utečen* OR azylant*") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 4.5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        plot.margin = margin(7, 30, 3, 0, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_y_continuous(
    expand = c(0, 0),
    breaks = seq(0, 1, 0.025),
    labels = paste0(seq(0, 100, 2.5), "%"),
    limits = c(0, max(combined_counts$migration_prop) + 0.05)
  )

ggsave("../5.write_up/presentation_CCL_march_2022/graphics/migration_content_proportion.png", device = "png",
       width = 1920, height = 1080, units = "px")
```

```{r}
# GRAPH 3: Proportion of migration content thorough time, grouped by media type, 2015-2023
combined_counts_grouped %>% 
  ggplot(aes(x = month, y = migration_prop, color = media_type)) +
  geom_line() +
  geom_point(size = 0.5) +
  geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), color = "#563a3a", linetype = 2, linewidth = 0.2) +
  geom_text(aes(x = graph_settings$dates[1], y = 0, label = graph_settings$events[1]), color = "#22209F", vjust = graph_settings$color_graph_adjust[1], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[2], y = 0, label = graph_settings$events[2]), color = "#22209F", vjust = graph_settings$color_graph_adjust[2], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[3], y = 0, label = graph_settings$events[3]), color = "#22209F", vjust = graph_settings$color_graph_adjust[3], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[4], y = 0, label = graph_settings$events[4]), color = "#22209F", vjust = graph_settings$color_graph_adjust[4], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[5], y = 0, label = graph_settings$events[5]), color = "#22209F", vjust = graph_settings$color_graph_adjust[5], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[6], y = 0, label = graph_settings$events[6]), color = "#22209F", vjust = graph_settings$color_graph_adjust[6], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[7], y = 0, label = graph_settings$events[7]), color = "#22209F", vjust = graph_settings$color_graph_adjust[7], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[8], y = 0, label = graph_settings$events[8]), color = "#22209F", vjust = graph_settings$color_graph_adjust[8], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = graph_settings$dates[9], y = 0, label = graph_settings$events[9]), color = "#22209F", vjust = graph_settings$color_graph_adjust[9], size = graph_settings$color_graph_txt_size, fontface = "bold", check_overlap = TRUE) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  labs(title = "Proportion of Migration Content in the Czech news media: 2015-2023",
       subtitle = "Percent of overall publishing output aggregated by month and split by media type",
       caption = "Data: Newton Media Archive, Media types: Vaclav Cvrcek & Jan Henys (2023), Search string: běženec* OR běženk* OR imigrant* OR migra* OR imigra* OR přistěhoval* OR uprchl* OR utečen* OR azylant*") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 4.5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.text = element_text(size = 9),
        legend.key = element_rect(fill = NA),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.8, 0.9),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_color_discrete(limits = c("alternative", "mainstream"),
                            labels = c("Alternative media","Mainstream media")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 1, 0.1),
  labels = paste0(seq(0, 100, 10), "%"),
  limits = c(0, max(combined_counts_grouped$migration_prop) + 0.05)
  )

ggsave("../5.write_up/conference_bratislava_october_2023/graphics/migration_content_proportion_by_media_type.png", device = "png",
       width = 1920, height = 1080, units = "px")

```

B&W Publication version

```{r}
combined_counts %>% 
  ggplot(aes(x = month, y = migration_prop)) +
    geom_line() +
    # geom_hline(yintercept = mean(combined_counts$migration_prop), linetype = 1, size = 0.1) +
    geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), linetype = 2, linewidth = 0.15) +
    geom_text(aes(x = graph_settings$dates[1], y = 0, hjust = 0.4, label = graph_settings$events[1]), vjust = graph_settings$bw_graph_adjust[1], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[2], y = 0, label = graph_settings$events[2]), vjust = graph_settings$bw_graph_adjust[2], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[3], y = 0, label = graph_settings$events[3]), vjust = graph_settings$bw_graph_adjust[3], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[4], y = 0, label = graph_settings$events[4]), vjust = graph_settings$bw_graph_adjust[4], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[5], y = 0, label = graph_settings$events[5]), vjust = graph_settings$bw_graph_adjust[5], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[6], y = 0, label = graph_settings$events[6]), vjust = graph_settings$bw_graph_adjust[6], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[7], y = 0, label = graph_settings$events[7]), vjust = graph_settings$bw_graph_adjust[7], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[8], y = 0, label = graph_settings$events[8]), vjust = graph_settings$bw_graph_adjust[8], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[9], y = 0, label = graph_settings$events[9]), vjust = graph_settings$bw_graph_adjust[9], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    ylab(element_blank()) +
    xlab(element_blank()) +
    # labs(title = "Proportion of Migration Content in Czech News Media, January 2015-February 2023") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(face = "bold", size = 7),
          axis.title.y = element_text(size = 8),
          legend.title = element_blank(),
          legend.text = element_text(size = 6),
          legend.background = element_rect(fill = NA),
          legend.position = c(0.735, 0.8),
          plot.margin = margin(7,30,3,5, "pt")) +
    scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
    coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
    scale_y_continuous(
    expand = c(0, 0),
    breaks = seq(0, 1, 0.1),
    labels = paste0(seq(0, 100, 10), "%"),
    limits = c(0, 1)
    )

ggsave("graphs/migration_content_proportion.png", device = "png",
       width = 1920, height = 1080, units = "px")
```

```{r}
combined_counts_grouped %>% 
  ggplot(aes(x = month, y = migration_prop, linetype = media_type)) +
    geom_line() +
    geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), linetype = 2, linewidth = 0.13) +
    geom_text(aes(x = graph_settings$dates[1], y = 0, hjust = 0.4, label = graph_settings$events[1]), vjust = graph_settings$bw_graph_adjust[1], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[2], y = 0, label = graph_settings$events[2]), vjust = graph_settings$bw_graph_adjust[2], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[3], y = 0, label = graph_settings$events[3]), vjust = graph_settings$bw_graph_adjust[3], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[4], y = 0, label = graph_settings$events[4]), vjust = graph_settings$bw_graph_adjust[4], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[5], y = 0, label = graph_settings$events[5]), vjust = graph_settings$bw_graph_adjust[5], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[6], y = 0, label = graph_settings$events[6]), vjust = graph_settings$bw_graph_adjust[6], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[7], y = 0, label = graph_settings$events[7]), vjust = graph_settings$bw_graph_adjust[7], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[8], y = 0, label = graph_settings$events[8]), vjust = graph_settings$bw_graph_adjust[8], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[9], y = 0, label = graph_settings$events[9]), vjust = graph_settings$bw_graph_adjust[9], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    ylab(element_blank()) +
    xlab(element_blank()) +
    # labs(title = "Proportion of Migration Content in Czech Mainstream and Alternative media, January 2015-February 2023") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(face = "bold", size = 7),
          axis.title.y = element_text(size = 8),
          legend.title = element_blank(),
          legend.text = element_text(size = 6, face = "bold"),
          legend.background = element_rect(fill = NA),
          legend.position = c(0.725, 0.8),
          plot.margin = margin(7,30,3,5, "pt")) +
    scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
    coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
    scale_linetype_discrete(limits = c("alternative", "mainstream"),
                            labels = c("Alternative media","Mainstream media")) +
    scale_y_continuous(
    expand = c(0, 0),
    breaks = seq(0, 1, 0.1),
    labels = paste0(seq(0, 100, 10), "%"),
    limits = c(0, 1)
    )

ggsave("graphs/migration_content_proportion_by_media_type.png", device = "png",
       width = 1920, height = 1080, units = "px")

```
#############################################################
Version of graph which uses events as a caption to the graph
```{r}

graph_settings <- list(dates = c(as.Date("2015-05-11"),
                        as.Date("2015-09-02"),
                        as.Date("2016-09-21"),
                        as.Date("2016-11-03"),
                        as.Date("2018-01-27"),
                        as.Date("2018-06-10"),
                        as.Date("2019-01-01"),
                        as.Date("2020-03-11"),
                        as.Date("2022-02-24")),
events = c(
1:9
), 
events_long_description = c(
  expression(
    paste(
      bold("(1)"), "EU Commission proposes refugee quotas, ",
      bold("(2) "), "Alan Kurdi drowns in the Mediterranean Sea, ",
      bold("(3) "), "Egypt shipwreck kills hundreds, ",
      bold("(4) "), "Two shipwrecks off Libyan coast, ",
      bold("(5) "), "Czech Republic re-elects Miloš Zeman as president, ",
      bold("(6) "), "Italy and Malta deny entry to NGO ship Aquarius, ",
      bold("(7) "), "EU reports lowest number of migrant arrivals in five years, ",
      bold("(8) "), "Covid-19 pandemic declared, ",
      bold("(9) "), "Russia invades Ukraine."
    )
  )
),
                      bw_graph_adjust = c(
                        -18,
                        -23,
                        -19,
                        -24,
                        -20,
                        -18,
                        -17,
                        -21,
                        -20
                      ),
bw_graph_txt_size = 3
                      )



combined_counts_grouped %>% 
  ggplot(aes(x = month, y = migration_prop, linetype = media_type)) +
    geom_line() +
    geom_vline(xintercept = as.numeric(graph_settings$dates[1:length(graph_settings$dates)]), linetype = 2, linewidth = 0.13) +
    geom_text(aes(x = graph_settings$dates[1], y = 0, hjust = 0.9, label = graph_settings$events[1]), vjust = graph_settings$bw_graph_adjust[1], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[2], y = 0, hjust = 0.5, label = graph_settings$events[2]), vjust = graph_settings$bw_graph_adjust[2], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[3], y = 0, hjust = 0.5, label = graph_settings$events[3]), vjust = graph_settings$bw_graph_adjust[3], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[4], y = 0, hjust = 0.5, label = graph_settings$events[4]), vjust = graph_settings$bw_graph_adjust[4], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[5], y = 0, hjust = 0.5, label = graph_settings$events[5]), vjust = graph_settings$bw_graph_adjust[5], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[6], y = 0, hjust = 0.5, label = graph_settings$events[6]), vjust = graph_settings$bw_graph_adjust[6], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[7], y = 0, hjust = 0.5, label = graph_settings$events[7]), vjust = graph_settings$bw_graph_adjust[7], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[8], y = 0, hjust = 0.5, label = graph_settings$events[8]), vjust = graph_settings$bw_graph_adjust[8], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    geom_text(aes(x = graph_settings$dates[9], y = 0, hjust = 0.5, label = graph_settings$events[9]), vjust = graph_settings$bw_graph_adjust[9], size = graph_settings$bw_graph_txt_size, check_overlap = TRUE) +
    ylab(element_blank()) +
    xlab(element_blank()) +
    labs(caption = graph_settings$events_long_description) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(face = "bold", size = 7),
          axis.title.y = element_text(size = 8),
          plot.caption = element_text(size = 3),
          legend.title = element_blank(),
          legend.text = element_text(size = 6, face = "bold"),
          legend.background = element_rect(fill = NA),
          legend.position = c(0.725, 0.8),
          plot.margin = margin(7,30,3,5, "pt")) +
    scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
    coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
    scale_linetype_discrete(limits = c("alternative", "mainstream"),
                            labels = c("Alternative media","Mainstream media")) +
    scale_y_continuous(
    expand = c(0, 0),
    breaks = seq(0, 1, 0.1),
    labels = paste0(seq(0, 100, 10), "%"),
    limits = c(0, 1)
    )

ggsave("graphs/test.png", device = "png",
       width = 1920, height = 1080, units = "px")


```


## Step 1.3: Clustering

```{r}
combined_counts_media_month <- readRDS("data/counts/combined_counts_media_month.rds")

prop_matrix <- combined_counts_media_month %>% 
  transmute(month, name = searched_name, migration_prop) %>% 
  pivot_wider(names_from = month, values_from = migration_prop) %>% 
  mutate(across(2:ncol(.), ~replace_na(.x, 0))) %>% 
  tibble::column_to_rownames("name") %>%  
  as.matrix()

# Determine optimal number of clusters with NbClust -----------------------

# Selected indexes
indexes <- c("frey", "mcclain", "cindex", "silhouette", "dunn")
# Prealocate list to which we append
nr_clust <- vector(mode = "list", length = length(indexes)) %>% setNames(indexes)

set.seed(2022)
# indices <- sample(1:dim(distance_matrix_all)[[1]], 500)
# distance_matrix_all_frac <- distance_matrix_all[indices, indices]

# Run for loop that appends the result of the selected index
for (i in indexes) {
  nr_clust[[i]] <- NbClust(data = prop_matrix, distance = "euclidean", min.nc = 2, max.nc = 7, method = "kmeans", index = i)[["Best.nc"]][["Number_clusters"]]
  print(i)
}

print(nr_clust)

# Set the most appropriate number of clusters based on the recommendation
clusters <- 2

kmeans_clust <- kmeans(prop_matrix, centers = clusters)

clust_inf <- combined_counts_media_month %>% left_join(data.frame(kmeans_clust$cluster, searched_name = names(kmeans_clust$cluster)), by = "searched_name")

clust_inf %>% 
  group_by(month, kmeans_clust.cluster) %>% 
  summarise(mean_prop = mean(migration_prop)) %>% 
  ggplot(aes(x = month, y = mean_prop, fill = as.factor( kmeans_clust.cluster))) +
  geom_col()


```

