---
title: "Word frequencies: refugee and migration terms"
---
Load necessary packages
```{r include=FALSE}
# Package names
packages <-
  c(
    "dplyr",
    "stringr",
    "purrr",
    "tidyr",
    "tidytext",
    "quanteda",
    "jsonlite",
    "ggplot2",
    "data.table",
    "plotly",
    "forcats",
    "ggwordcloud",
    "ggpubr",
    "parallel",
    "tibble",
    "pbmcapply"
  )

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

# Import media labels
media_labels <- readRDS("../../1.data_sources/media_articles/data/media_type_labels/all_media_labels_with_doc_id.rds")

# Path of UDPIPE processed data
list_of_udpipe_chunks <- list.files(path = "../../2.data_transformations/media_articles/data/udpipe_processed/chunks", pattern = "*.rds", full.names = TRUE)

# Pattern for matching
regex_pattern <- "(běženec\\S*)|(běženk\\S*)|(imigrant\\S*)|(migra\\S*)|(imigra\\S*)|(přistěhoval\\S*)|(uprchl\\S*)|(utečen\\S*)|(azylant\\S*)"

```

Get information about date of publication for each of the documents
```{r}
annotated_df_path <- "../../1.data_sources/media_articles/data/annotations/chunks/"

# Get info on doc_id and date of publication
doc_id_by_date <- list.files(path = annotated_df_path,
                             pattern = "*.rds",
                             full.names = TRUE) %>%
  map_dfr(readRDS) %>%
  transmute(date = as.Date(datePublished),
            doc_id = code)

saveRDS(doc_id_by_date, "data/doc_id_by_date_and_words.rds")
```


Get information about number of tokens and sentences for each of the documents
```{r}

# Path of UDPIPE processed data
list_of_udpipe_chunks <- list.files(path = "../../2.data_transformations/media_articles/data/udpipe_processed/chunks", pattern = "*.rds", full.names = TRUE)

get_token_counts <- function(chunk_path) {
  chunk_path %>% 
      readRDS() %>% 
      group_by(doc_id) %>% 
      summarize(nr_tokens = n(),
                nr_sentences = max(sentence_id))
    
}

token_counts_per_doc <- pbmclapply(list_of_udpipe_chunks, get_token_counts, mc.cores = detectCores() - 1) %>% 
  bind_rows()

saveRDS(token_counts_per_doc, "data/token_counts_per_doc.rds")

```

How many tokens and sentences does the main corpus and sub-corpora have?
```{r}
print(paste("The overall corpus has", nrow(token_counts_per_doc), "documents and", sum(token_counts_per_doc$nr_tokens)/1000000, "million tokens and", sum(token_counts_per_doc$nr_sentences)/1000000, "million sentences."))

alternative_sub_corpus_stats <- token_counts_per_doc %>% 
  inner_join(media_labels, "doc_id") %>% 
  filter(media_type %in% c("antisystem", "political_tabloid")) %>% 
  left_join(doc_id_by_date, "doc_id")

mainstream_sub_corpus_stats <- token_counts_per_doc %>% 
  inner_join(media_labels, "doc_id") %>% 
  filter(media_type %in% c("mainstream")) %>% 
  left_join(doc_id_by_date, "doc_id")

print(paste("Between", min(alternative_sub_corpus_stats$date), "and", max(alternative_sub_corpus_stats$date), "the alternative media corpus has", nrow(alternative_sub_corpus_stats), "documents from", length(unique(alternative_sub_corpus_stats$name)), "media outlets and", sum(alternative_sub_corpus_stats$nr_tokens)/1000000, "million tokens and", sum(alternative_sub_corpus_stats$nr_sentences)/1000000, "million sentences."))

print(paste("Between", min(mainstream_sub_corpus_stats$date), "and", max(mainstream_sub_corpus_stats$date), "the mainstream media corpus has", nrow(mainstream_sub_corpus_stats), "documents from", length(unique(mainstream_sub_corpus_stats$name)), "media outlets and", sum(mainstream_sub_corpus_stats$nr_tokens)/1000000, "million tokens and", sum(mainstream_sub_corpus_stats$nr_sentences)/1000000, "million sentences."))

subperiods_corpus_list <- vector("list", length = 2L) %>% setNames(c("alternative", "mainstream"))

subperiods_corpus_list[["alternative"]][[1]] <-  alternative_sub_corpus_stats %>% 
  filter(date >= as.Date("2015-01-01") & date <= as.Date("2015-12-31"))

subperiods_corpus_list[["alternative"]][[2]] <- alternative_sub_corpus_stats %>% 
  filter(date >= as.Date("2016-01-01") & date <= as.Date("2022-01-31"))

subperiods_corpus_list[["alternative"]][[3]] <-   alternative_sub_corpus_stats %>% 
  filter(date >= as.Date("2022-02-01") & date <= as.Date("2023-02-28"))

subperiods_corpus_list[["mainstream"]][[1]] <- mainstream_sub_corpus_stats %>% 
  filter(date >= as.Date("2015-01-01") & date <= as.Date("2015-12-31"))

subperiods_corpus_list[["mainstream"]][[2]] <- mainstream_sub_corpus_stats %>% 
  filter(date >= as.Date("2016-01-01") & date <= as.Date("2022-01-31"))

subperiods_corpus_list[["mainstream"]][[3]] <- mainstream_sub_corpus_stats %>% 
  filter(date >= as.Date("2022-02-01") & date <= as.Date("2023-02-28"))

# Repeat for sub-corpora split by periods
for (o in seq_along(subperiods_corpus_list)) {
  for (i in seq_along(subperiods_corpus_list[[o]]))
    
    print(
      paste(
        "Between",
        min(subperiods_corpus_list[[o]][[i]][["date"]]),
        "and",
        max(subperiods_corpus_list[[o]][[i]][["date"]]),
        "the",
        names(subperiods_corpus_list[o]),
        "media corpus has",
        nrow(subperiods_corpus_list[[o]][[i]]),
        "documents from",
        length(unique(subperiods_corpus_list[[o]][[i]][["name"]])),
        "media outlets and",
        sum(subperiods_corpus_list[[o]][[i]][["nr_tokens"]]) / 1000000,
        "million tokens and",
        sum(subperiods_corpus_list[[o]][[i]][["nr_sentences"]]) / 1000000,
        "million sentences."
      )
    )
}

```


```{r}
get_matches <- function(chunk_path) {
  chunk_path %>% 
        readRDS() %>% 
        transmute(doc_id, lemma = tolower(lemma)) %>% 
        filter(str_detect(lemma, regex_pattern))
}

key_lemma_per_doc <- mclapply(list_of_udpipe_chunks, get_matches, mc.cores = detectCores() - 1) %>% 
  bind_rows()

saveRDS(key_lemma_per_doc, "data/key_lemma_per_doc.rds")

# Which of our searched words were the most common? This helps us to create our lexicon
most_common_terms <- key_lemma_per_doc %>%
  count(lemma, sort = TRUE) %>%
  filter(n >= 10)

```


```{r}
# Created manually through the interface of the Questionr package
# This named vector is used in the middle of the transformation in the next
lexicon <- c(
  "migration_term" = "nízkomigrační",
  "migration_term" = "polomigrant",
  "migration_term" = "postmigrantský",
  "migration_term" = "předimigrační",
  "migration_term" = "předmigrační",
  "migration_term" = "přistěhovalca",
  "migration_term" = "přistěhovalecki",
  "migration_term" = "proiimigrační",
  "migration_term" = "proimigračně",
  "migration_term" = "proimigrační",
  "migration_term" = "proimigračný",
  "migration_term" = "proimigranstký",
  "migration_term" = "proimigrantsky",
  "migration_term" = "proimigrantský",
  "migration_term" = "promigrace",
  "migration_term" = "promigračně",
  "migration_term" = "promigrační",
  "migration_term" = "promigračný",
  "migration_term" = "promigrant",
  "migration_term" = "promigrantský",
  "migration_term" = "prootiimigrační",
  "migration_term" = "propřistěhovalecký",
  "migration_term" = "protiemigrační",
  "migration_term" = "protiemigrantský",
  "unknown" = "protiimigraci.cz",
  "migration_term" = "protiimigračně",
  "migration_term" = "protiimigracni",
  "migration_term" = "protiimigrační",
  "migration_term" = "protiimigračný",
  "migration_term" = "protiimigranční",
  "migration_term" = "protiimigranský",
  "migration_term" = "protiimigrantsky",
  "migration_term" = "protiimigrantský",
  "migration_term" = "protimigračně",
  "migration_term" = "protimigrační",
  "migration_term" = "protimigračný",
  "migration_term" = "protimigrantsky",
  "migration_term" = "protimigrantský",
  "migration_term" = "protimimigrační",
  "migration_term" = "protipřistěhovalecký",
  "migration_term" = "reemigrace",
  "migration_term" = "reemigrační",
  "migration_term" = "reemigrant",
  "migration_term" = "remigrace",
  "migration_term" = "remigration",
  "migration_term" = "transmigrant",
  "migration_term" = "unmigration",
  "migration_term" = "migrantcrisis",
  "migration_term" = "migrantenschreck",
  "unknown" = "migrantika",
  "migration_term" = "migrantní",
  "migration_term" = "migrantofil",
  "unknown" = "migrantour",
  "migration_term" = "migrantow",
  "migration_term" = "migrantów",
  "migration_term" = "migrantówa",
  "migration_term" = "migrantsky",
  "unknown" = "migrantu.htmla",
  "migration_term" = "migrantum",
  "migration_term" = "migrantův",
  "migration_term" = "migrantuzprava",
  "migration_term" = "migrantyzprav",
  "unknown" = "migranyan",
  "migration_term" = "migrar",
  "unknown" = "migrastatický",
  "unknown" = "migrat",
  "unknown" = "migratatika",
  "unknown" = "migratica",
  "migration_term" = "migratio",
  "migration_term" = "migrationshintergrund",
  "migration_term" = "migrationskrise",
  "migration_term" = "migrationspakt",
  "migration_term" = "migrationspolitik",
  "migration_term" = "migrationswelle",
  "unknown" = "migratn",
  "unknown" = "migratoires",
  "migration_term" = "migrator",
  "migration_term" = "migratorio",
  "migration_term" = "migratorium",
  "migration_term" = "migrazioni",
  "unknown" = "mil.migranta",
  "migration_term" = "neimigrant",
  "migration_term" = "nemigrant",
  "refugee_term" = "neuprchlík",
  "refugee_term" = "protiběženecký",
  "refugee_term" = "protiuprchlicky",
  "refugee_term" = "protiuprchlický",
  "refugee_term" = "protiutečenecký",
  "refugee_term" = "prouprchlicky",
  "refugee_term" = "prouprchlický",
  "refugee_term" = "pseudouprchlík",
  "refugee_term" = "spoluuprchlík",
  "refugee_term" = "uprchlec",
  "refugee_term" = "uprchlék",
  "refugee_term" = "uprchlení",
  "refugee_term" = "uprchlíček",
  "refugee_term" = "uprchlich",
  "refugee_term" = "uprchlícičekající",
  "refugee_term" = "uprchlicich",
  "refugee_term" = "uprchlick",
  "refugee_term" = "uprchlicka",
  "refugee_term" = "uprchlíčka",
  "refugee_term" = "uprchlicki",
  "refugee_term" = "uprchlickich",
  "refugee_term" = "uprchlicko",
  "refugee_term" = "uprchlícký",
  "refugee_term" = "uprchlickych",
  "refugee_term" = "uprchlictvi",
  "refugee_term" = "uprchlíctví",
  "refugee_term" = "uprchlictvo",
  "refugee_term" = "uprchlik",
  "refugee_term" = "uprchlika",
  "refugee_term" = "uprchlíkůa",
  "refugee_term" = "uprchlíkůčesko",
  "refugee_term" = "uprchlíkůda",
  "refugee_term" = "uprchlíkůdialyzační",
  "refugee_term" = "uprchlíkůkda",
  "refugee_term" = "uprchlikum",
  "refugee_term" = "uprchlíkůmčeš",
  "refugee_term" = "uprchlíkůmdůležitý",
  "refugee_term" = "uprchlíkůna",
  "refugee_term" = "uprchlíkůněmce",
  "refugee_term" = "uprchlíkůněmecký",
  "refugee_term" = "uprchlíkůodmítnit",
  "refugee_term" = "uprchlíkůpapež",
  "refugee_term" = "uprchlíkůpodle",
  "refugee_term" = "uprchlíkůrakousko",
  "refugee_term" = "uprchlíkůřecko",
  "refugee_term" = "uprchlíkův",
  "unknown" = "kmigrace",
  "migration_term" = "limmigration",
  "migration_term" = "migračí",
  "unknown" = "migraci.tka",
  "migration_term" = "migracie",
  "migration_term" = "migracio",
  "migration_term" = "migración",
  "migration_term" = "migraciones",
  "migration_term" = "migracna",
  "migration_term" = "migracne",
  "unknown" = "migrahí",
  "unknown" = "migrain",
  "unknown" = "migraland",
  "unknown" = "migramar",
  "unknown" = "migranat",
  "migration_term" = "migrančí",
  "unknown" = "migranjan",
  "migration_term" = "migranský",
  "migration_term" = "migranstký",
  "migration_term" = "migrantama",
  "unknown" = "migrationsverket",
  "unknown" = "migrationwatch",
  "unknown" = "migrationwiz",
  "unknown" = "online.imigrasi.go.id",
  "unknown" = "pomocuprchlikum.cz",
  "unknown" = "refugeesmigrants.un.org",
  "unknown" = "uprchlémfrancouzský",
  "unknown" = "uprchliky.html",
  "refugee_term" = "uprchlíkyčesko",
  "refugee_term" = "uprchlíkynejčasto",
  "refugee_term" = "uprchlíkyv",
  "unknown" = "uprchlípník",
  "refugee_term" = "uprchlit",
  "unknown" = "uprchlívák",
  "refugee_term" = "uprchlk",
  "refugee_term" = "utečen",
  "refugee_term" = "utečenc",
  "refugee_term" = "utečencký",
  "refugee_term" = "utečencova",
  "refugee_term" = "utečeneckú",
  "refugee_term" = "utečenectvo",
  "refugee_term" = "utečenkyňa",
  "refugee_term" = "utečenkyně",
  "refugee_term" = "utečenský",
  "refugee_term" = "utečenův",
  "refugee_term" = "azylant",
  "refugee_term" = "azylanta",
  "refugee_term" = "azylanté",
  "refugee_term" = "azylanti",
  "refugee_term" = "azylantské",
  "refugee_term" = "azylantů",
  "refugee_term" = "azylanty",
  "refugee_term" = "běženec",
  "refugee_term" = "běženectví",
  "unknown" = "chodili",
  "migration_term" = "imigra",
  "migration_term" = "imigrace",
  "migration_term" = "imigracecz",
  "migration_term" = "imigraci",
  "migration_term" = "imigrací",
  "migration_term" = "imigračné",
  "migration_term" = "imigračného",
  "migration_term" = "imigračnej",
  "migration_term" = "imigrační",
  "migration_term" = "imigračních",
  "migration_term" = "imigračního",
  "migration_term" = "imigračním",
  "migration_term" = "imigračními",
  "migration_term" = "imigrafická",
  "migration_term" = "imigrant",
  "migration_term" = "imigranta",
  "migration_term" = "imigrante",
  "migration_term" = "imigrantech",
  "migration_term" = "imigrantem",
  "migration_term" = "imigranti",
  "migration_term" = "imigrantka",
  "migration_term" = "imigrantky",
  "migration_term" = "imigrantmi",
  "migration_term" = "imigrantom",
  "migration_term" = "imigrantov",
  "migration_term" = "imigrantovi",
  "migration_term" = "imigrantska",
  "migration_term" = "imigrantské",
  "migration_term" = "imigrantského",
  "migration_term" = "imigrantskému",
  "migration_term" = "imigrantský",
  "migration_term" = "imigrantských",
  "migration_term" = "imigrantskými",
  "migration_term" = "imigrantství",
  "migration_term" = "imigrantů",
  "migration_term" = "imigrantum",
  "migration_term" = "imigrantům",
  "migration_term" = "imigranty",
  "migration_term" = "migrac",
  "migration_term" = "migrace",
  "migration_term" = "migraci",
  "migration_term" = "migrací",
  "migration_term" = "migracích",
  "migration_term" = "migracihovory",
  "migration_term" = "migracii",
  "migration_term" = "migracím",
  "migration_term" = "migračné",
  "migration_term" = "migračně",
  "migration_term" = "migračnej",
  "migration_term" = "migrační",
  "migration_term" = "migračních",
  "migration_term" = "migračního",
  "migration_term" = "migračním",
  "migration_term" = "migračními",
  "migration_term" = "migračných",
  "unknown" = "migraine",
  "migration_term" = "migrančmní",
  "migration_term" = "migrans",
  "migration_term" = "migrant",
  "migration_term" = "migranta",
  "migration_term" = "migrantech",
  "migration_term" = "migrantek",
  "migration_term" = "migrantem",
  "migration_term" = "migrantes",
  "migration_term" = "migranti",
  "migration_term" = "migrantka",
  "migration_term" = "migrantky",
  "migration_term" = "migrantov",
  "migration_term" = "migrantovy",
  "migration_term" = "migrantská",
  "migration_term" = "migrantské",
  "migration_term" = "migrantských",
  "migration_term" = "migrantským",
  "migration_term" = "migrantů",
  "migration_term" = "migrantům",
  "migration_term" = "migranty",
  "migration_term" = "migration",
  "migration_term" = "přistěhoval",
  "migration_term" = "přistěhovala",
  "migration_term" = "přistěhovalá",
  "migration_term" = "přistěhovalce",
  "migration_term" = "přistěhovalci",
  "migration_term" = "přistěhovalců",
  "migration_term" = "přistěhovalcům",
  "migration_term" = "přistěhovalé",
  "migration_term" = "přistěhovalec",
  "migration_term" = "přistěhovalecká",
  "migration_term" = "přistěhovalecké",
  "migration_term" = "přistěhovaleckého",
  "migration_term" = "přistěhovaleckých",
  "migration_term" = "přistěhovalectví",
  "migration_term" = "přistěhovali",
  "migration_term" = "přistěhovalí",
  "migration_term" = "přistěhovalo",
  "migration_term" = "přistěhovaly",
  "migration_term" = "přistěhovalých",
  "migration_term" = "přistěhovalým",
  "migration_term" = "přistěhovalými",
  "refugee_term" = "uprchl",
  "refugee_term" = "uprchla",
  "refugee_term" = "uprchlá",
  "refugee_term" = "uprchlé",
  "refugee_term" = "uprchlého",
  "refugee_term" = "uprchlém",
  "refugee_term" = "uprchlému",
  "refugee_term" = "uprchli",
  "refugee_term" = "uprchlí",
  "refugee_term" = "uprchlice",
  "refugee_term" = "uprchlicemi",
  "refugee_term" = "uprchlici",
  "refugee_term" = "uprchlicí",
  "refugee_term" = "uprchlíci",
  "refugee_term" = "uprchlících",
  "refugee_term" = "uprchlická",
  "refugee_term" = "uprchlicke",
  "refugee_term" = "uprchlické",
  "refugee_term" = "uprchlického",
  "refugee_term" = "uprchlickém",
  "refugee_term" = "uprchlickou",
  "refugee_term" = "uprchlický",
  "refugee_term" = "uprchlických",
  "refugee_term" = "uprchlictví",
  "refugee_term" = "uprchlík",
  "refugee_term" = "uprchlíka",
  "refugee_term" = "uprchlíkama",
  "refugee_term" = "uprchlíkem",
  "refugee_term" = "uprchlíkovi",
  "refugee_term" = "uprchlíku",
  "refugee_term" = "uprchlíků",
  "refugee_term" = "uprchlíkům",
  "refugee_term" = "uprchlíky",
  "refugee_term" = "uprchlo",
  "refugee_term" = "uprchlou",
  "refugee_term" = "uprchly",
  "refugee_term" = "uprchlý",
  "refugee_term" = "uprchlých",
  "refugee_term" = "uprchlým",
  "refugee_term" = "uprchlými",
  "refugee_term" = "utečence",
  "refugee_term" = "utečenci",
  "refugee_term" = "utečencom",
  "refugee_term" = "utečencov",
  "refugee_term" = "utečenců",
  "refugee_term" = "utečenec",
  "refugee_term" = "utečenecká",
  "refugee_term" = "utečenecké",
  "refugee_term" = "utečeneckého",
  "refugee_term" = "utečeneckém",
  "refugee_term" = "utečeneckom",
  "refugee_term" = "utečenkyňou",
  "unknown" = "13",
  "unknown" = "3",
  "unknown" = "43",
  "unknown" = "at",
  "refugee_term" = "azylantech",
  "refugee_term" = "azylantek",
  "refugee_term" = "azylantem",
  "refugee_term" = "azylantka",
  "refugee_term" = "azylantku",
  "refugee_term" = "azylantky",
  "refugee_term" = "azylantovi",
  "refugee_term" = "azylantský",
  "refugee_term" = "azylantských",
  "refugee_term" = "azylantům",
  "unknown" = "bandcamp",
  "refugee_term" = "běženecká",
  "refugee_term" = "běženecké",
  "refugee_term" = "běženecky",
  "refugee_term" = "běženeckých",
  "refugee_term" = "běženkyně",
  "refugee_term" = "běženkyni",
  "refugee_term" = "běženkyním",
  "unknown" = "com",
  "unknown" = "cz",
  "unknown" = "do",
  "migration_term" = "imigračná",
  "migration_term" = "imigračně",
  "migration_term" = "imigračnému",
  "migration_term" = "imigračněprávní",
  "migration_term" = "imigracni",
  "migration_term" = "imigracní",
  "migration_term" = "imigračnímu",
  "migration_term" = "imigračnou",
  "migration_term" = "imigračných",
  "migration_term" = "imigračným",
  "migration_term" = "imigran",
  "migration_term" = "imigrankprotože",
  "migration_term" = "imigrantama",
  "migration_term" = "imigrantce",
  "migration_term" = "imigrantek",
  "migration_term" = "imigrantkám",
  "migration_term" = "imigrantkami",
  "migration_term" = "imigrantkou",
  "migration_term" = "imigrantku",
  "migration_term" = "imigrantoch",
  "migration_term" = "imigrantovu",
  "migration_term" = "imigrantská",
  "migration_term" = "imigrantskej",
  "migration_term" = "imigrantském",
  "migration_term" = "imigrantsko",
  "migration_term" = "imigrantskou",
  "migration_term" = "imigrantským",
  "migration_term" = "imigrantští",
  "migration_term" = "imigrantu",
  "migration_term" = "imigraotnovi",
  "migration_term" = "imigratnských",
  "migration_term" = "imigratů",
  "unknown" = "it",
  "unknown" = "js",
  "unknown" = "k",
  "unknown" = "ma",
  "unknown" = "měla",
  "migration_term" = "migra",
  "migration_term" = "migrač",
  "migration_term" = "migracemi",
  "migration_term" = "migracena",
  "migration_term" = "migracev",
  "migration_term" = "migraceza",
  "migration_term" = "migracezarazitúplně",
  "migration_term" = "migracia",
  "migration_term" = "migracja",
  "migration_term" = "migracje",
  "migration_term" = "migracji",
  "migration_term" = "migračmigračje",
  "migration_term" = "migračná",
  "migration_term" = "migračného",
  "migration_term" = "migračněhumanitární",
  "migration_term" = "migracni",
  "migration_term" = "migračnim",
  "migration_term" = "migračnímu",
  "migration_term" = "migračnú",
  "migration_term" = "migračný",
  "unknown" = "migraines",
  "unknown" = "migralgin",
  "unknown" = "migramah",
  "unknown" = "migran",
  "unknown" = "migranas",
  "unknown" = "migrance",
  "migration_term" = "migranční",
  "unknown" = "migrane",
  "unknown" = "migranea",
  "unknown" = "migranetem",
  "unknown" = "migrano",
  "migration_term" = "migranstvem",
  "migration_term" = "migrantce",
  "migration_term" = "migrante",
  "migration_term" = "migranten",
  "unknown" = "migrantiek",
  "migration_term" = "migrantin",
  "unknown" = "migrantium",
  "unknown" = "migrantiv",
  "migration_term" = "migrantkách",
  "migration_term" = "migrantkám",
  "migration_term" = "migrantkami",
  "migration_term" = "migrantkou",
  "migration_term" = "migrantku",
  "migration_term" = "migrantkypokud",
  "migration_term" = "migrantom",
  "migration_term" = "migrantos",
  "migration_term" = "migrantova",
  "migration_term" = "migrantovi",
  "migration_term" = "migrants",
  "migration_term" = "migrantského",
  "migration_term" = "migrantskej",
  "migration_term" = "migrantskou",
  "migration_term" = "migrantský",
  "migration_term" = "migrantství",
  "migration_term" = "migrantu",
  "migration_term" = "migrare",
  "unknown" = "migrastatické",
  "unknown" = "migrastatickou",
  "unknown" = "migrastatik",
  "unknown" = "migrastatika",
  "migration_term" = "migrate",
  "migration_term" = "migrated",
  "migration_term" = "migrates",
  "migration_term" = "migratie",
  "migration_term" = "migrating",
  "migration_term" = "migrationhealth",
  "migration_term" = "migrations",
  "migration_term" = "migrationsfeindlichen",
  "migration_term" = "migrationskritischen",
  "migration_term" = "migratoire",
  "migration_term" = "migratoria",
  "migration_term" = "migratorius",
  "migration_term" = "migratorní",
  "migration_term" = "migratory",
  "unknown" = "na",
  "migration_term" = "přistěhovalcem",
  "migration_term" = "přistěhovalcích",
  "migration_term" = "přistěhovalcina",
  "migration_term" = "přistěhovaleckému",
  "migration_term" = "přistěhovaleckou",
  "migration_term" = "přistěhovalecký",
  "migration_term" = "přistěhovaleckým",
  "migration_term" = "přistěhovaleckými",
  "migration_term" = "přistěhovalectvím",
  "migration_term" = "přistěhovalého",
  "migration_term" = "přistěhovalému",
  "migration_term" = "přistěhovalkyň",
  "migration_term" = "přistěhovalkyně",
  "migration_term" = "přistěhovalkyni",
  "migration_term" = "přistěhovalou",
  "migration_term" = "přistěhovalsů",
  "migration_term" = "přistěhovalý",
  "refugee_term" = "uprchlci",
  "refugee_term" = "uprchle",
  "refugee_term" = "uprchlic",
  "refugee_term" = "uprchlící",
  "refugee_term" = "uprchlíci1",
  "refugee_term" = "uprchlicích",
  "refugee_term" = "uprchlicím",
  "refugee_term" = "uprchlickéhotáborajde",
  "refugee_term" = "uprchlickému",
  "refugee_term" = "uprchlicky",
  "refugee_term" = "uprchlickýho",
  "refugee_term" = "uprchlickým",
  "refugee_term" = "uprchlickými",
  "refugee_term" = "uprchličtí",
  "refugee_term" = "uprchlictvím",
  "refugee_term" = "uprchlíkovy",
  "refugee_term" = "uprchliku",
  "refugee_term" = "uprchlikuv",
  "refugee_term" = "uprchliky",
  "refugee_term" = "uprchlíkyproč",
  "refugee_term" = "utečená",
  "refugee_term" = "utečencami",
  "refugee_term" = "utečenče",
  "refugee_term" = "utečencem",
  "refugee_term" = "utečencích",
  "refugee_term" = "utečencům",
  "refugee_term" = "utečeneckej",
  "refugee_term" = "utečeneckou",
  "refugee_term" = "utečenecku",
  "refugee_term" = "utečenecký",
  "refugee_term" = "utečeneckých",
  "refugee_term" = "utečenectva",
  "refugee_term" = "utečenectví",
  "refugee_term" = "utečeni",
  "refugee_term" = "utečení",
  "refugee_term" = "utečenka",
  "refugee_term" = "utečeny",
  "refugee_term" = "utečený",
  "refugee_term" = "utečených",
  "unknown" = "az",
  "unknown" = "čím",
  "unknown" = "gob",
  "migration_term" = "imigračn",
  "migration_term" = "imigračněprávních",
  "migration_term" = "imigracního",
  "migration_term" = "imigračnim",
  "migration_term" = "imigračnú",
  "migration_term" = "imigračnými",
  "migration_term" = "imigrantú",
  "migration_term" = "imigraty",
  "unknown" = "jpg",
  "migration_term" = "migracebrbr",
  "migration_term" = "migraceinfo",
  "migration_term" = "migraceing",
  "migration_term" = "migraceonline",
  "migration_term" = "migracion",
  "migration_term" = "migraciplatforma",
  "migration_term" = "migračnívlna",
  "migration_term" = "migračnou",
  "migration_term" = "migracnu",
  "unknown" = "migrad",
  "unknown" = "migrainefacts",
  "unknown" = "migrainefoundation",
  "unknown" = "migraineresearchfoundation",
  "unknown" = "migrainesknee",
  "unknown" = "migrainesummit2017",
  "unknown" = "migraineux",
  "unknown" = "migrastatická",
  "unknown" = "migrastatickým",
  "unknown" = "migrate2rocky",
  "migration_term" = "migratepage",
  "migration_term" = "migrati",
  "migration_term" = "migrationology",
  "migration_term" = "migratori",
  "unknown" = "migratorybirdfestival",
  "migration_term" = "migravoat",
  "migration_term" = "migrazione",
  "unknown" = "mimmo",
  "unknown" = "ministerstvo",
  "unknown" = "ne",
  "unknown" = "pokud",
  "unknown" = "potom",
  "migration_term" = "přistěhovaleckém",
  "migration_term" = "přistěhovalečtí",
  "migration_term" = "přistěhovalství",
  "refugee_term" = "uprchleho",
  "refugee_term" = "uprchlícivýraznou",
  "refugee_term" = "uprchlíciz",
  "refugee_term" = "uprchlíkůjihokorejský",
  "refugee_term" = "uprchlíkůmatthew",
  "refugee_term" = "utečenca",
  "refugee_term" = "utečencoch",
  "refugee_term" = "utečené",
  "refugee_term" = "utečenej",
  "refugee_term" = "utečenku",
  "refugee_term" = "utečenky",
  "migration_term" = "antiimigrace",
  "migration_term" = "antiimigračně",
  "migration_term" = "antiimigrační",
  "migration_term" = "antiimigračný",
  "migration_term" = "antiimigrantsky",
  "migration_term" = "antiimigrantský",
  "migration_term" = "antimigrační",
  "migration_term" = "antimigrant",
  "migration_term" = "antimigrantský",
  "migration_term" = "antipřistěhovalecký",
  "refugee_term" = "antiuprchlický",
  "refugee_term" = "azylantom",
  "refugee_term" = "azylantov",
  "refugee_term" = "azylantova",
  "refugee_term" = "azylantův",
  "refugee_term" = "běženecký",
  "refugee_term" = "běženka",
  "refugee_term" = "běženkyní",
  "unknown" = "drahonicíchuprchlík",
  "migration_term" = "emigrace",
  "migration_term" = "emigračka",
  "migration_term" = "emigrační",
  "migration_term" = "emigrant",
  "migration_term" = "emigranta",
  "migration_term" = "emigranten",
  "migration_term" = "emigrantka",
  "migration_term" = "emigrantov",
  "migration_term" = "emigrantský",
  "migration_term" = "emigrantství",
  "migration_term" = "emigrantův",
  "migration_term" = "emigrate",
  "migration_term" = "emigrated",
  "migration_term" = "emigration",
  "unknown" = "flexmigration",
  "unknown" = "geomigrace",
  "migration_term" = "ileg.imigrace",
  "migration_term" = "imigracao",
  "migration_term" = "imigracionistický",
  "migration_term" = "imigracne",
  "migration_term" = "imigračný",
  "migration_term" = "imigrance",
  "migration_term" = "imigranční",
  "migration_term" = "imigranský",
  "migration_term" = "imigranstký",
  "unknown" = "imigranta.cz",
  "migration_term" = "imigrantes",
  "migration_term" = "imigrantový",
  "migration_term" = "imigrantow",
  "migration_term" = "imigrantske",
  "migration_term" = "imigrantsky",
  "unknown" = "imigrantu.aspx",
  "migration_term" = "imigrantův",
  "unknown" = "imigrat",
  "migration_term" = "imigration",
  "migration_term" = "imigratka",
  "migration_term" = "imigratský",
  "migration_term" = "immigrace",
  "migration_term" = "immigrance",
  "migration_term" = "immigrant",
  "migration_term" = "immigrat",
  "migration_term" = "immigrated",
  "migration_term" = "immigration",
  "migration_term" = "immigrato",
  "migration_term" = "immigrazione",
  "unknown" = "infomigrant",
  "unknown" = "infomigrants",
  "unknown" = "infomigrants.net",
  "migration_term" = "inmigracion",
  "migration_term" = "inmigrant",
  "migration_term" = "inmigrantes",
  "refugee_term" = "jsmeuprchlík",
  "migration_term" = "klimigrace",
  "migration_term" = "krimigrant",
  "migration_term" = "krimigrantský",
  "migration_term" = "kvazimigrant",
  "migration_term" = "massenmigration",
  "unknown" = "migrace.com",
  "unknown" = "migraceonline.cz",
  "unknown" = "www.emigrationmuseum.cz",
  "unknown" = "www.immigration.govt.nz",
  "unknown" = "www.migrace.com",
  "unknown" = "www.migraceonline.cz",
  "unknown" = "www.pomocuprchlikum.cz",
  "unknown" = "www.protiimigraci.cz"
) %>% enframe("category", "lemma")

```

```{r}
doc_id_by_date <- readRDS("data/doc_id_by_date.rds")
key_lemma_per_doc <- readRDS("data/key_lemma_per_doc.rds")
token_counts_per_doc <- readRDS("data/token_counts_per_doc.rds")
nr_tokens_in_corpus <- sum(token_counts_per_doc$nr_tokens)
nr_tokens_in_alt_corpus <- sum(alternative_sub_corpus_stats$nr_tokens)
nr_tokens_in_mainst_corpus <- sum(mainstream_sub_corpus_stats$nr_tokens)

key_dates <- setNames(c(as.Date("2015-05-11"),
                        as.Date("2015-09-02"),
                        as.Date("2016-09-21"),
                        as.Date("2016-11-03"),
                        as.Date("2018-01-27"),
                        as.Date("2018-06-10"),
                        as.Date("2019-01-01"),
                        as.Date("2020-03-11"),
                        as.Date("2022-02-24")),
                      c("EU quota",
                        "Alan Kurdi",
                        "Egypt shipwreck",
                        "Libya shipwreck",
                        "Miloš Zeman re-election",
                        "Aquarius rejection",
                        "Lowest 5yr arrivals",
                        "Pandemic start",
                        "Invasion of Ukraine"))


# Graph zoom date end & beginning
start_date <- as.Date("2015-01-01")
end_date <- as.Date("2023-03-01")
```

Term occurences in the whole corpus and ALT/Mainst sub-corpora, adjusted to instances per million (ipm)

```{r}
frequency_summary_all <- key_lemma_per_doc %>% 
  inner_join(lexicon, by = "lemma") %>% 
  inner_join(doc_id_by_date, by = "doc_id") %>%
  mutate(date = as.Date(cut(date, "months"))) %>% 
  filter(date < as.Date("2023-03-01") & category != "unknown") %>% 
  count(date, category, name = "monthly_count") %>% 
  ungroup() %>% 
  mutate(ipm_freq = (monthly_count/nr_tokens_in_corpus)*1000000)

saveRDS(frequency_summary_all, "data/frequency_summary_all.rds")

alt_frequency_summary <- key_lemma_per_doc %>%
  inner_join(media_labels, "doc_id") %>%
  filter(media_type %in% c("antisystem", "political_tabloid")) %>%
  inner_join(lexicon, by = "lemma") %>%
  inner_join(doc_id_by_date, by = "doc_id") %>%
  mutate(date = as.Date(cut(date, "months"))) %>%
  filter(date < as.Date("2023-03-01") &
           category != "unknown") %>%
  count(date, category, name = "monthly_count") %>%
  ungroup() %>%
  mutate(ipm_freq = (monthly_count / nr_tokens_in_alt_corpus) * 1000000)

saveRDS(alt_frequency_summary, "data/alt_frequency_summary.rds")

mainst_frequency_summary <- key_lemma_per_doc %>%
  inner_join(media_labels, "doc_id") %>%
  filter(media_type == "mainstream") %>%
  inner_join(lexicon, by = "lemma") %>%
  inner_join(doc_id_by_date, by = "doc_id") %>%
  mutate(date = as.Date(cut(date, "months"))) %>%
  filter(date < as.Date("2023-03-01") &
           category != "unknown") %>%
  count(date, category, name = "monthly_count") %>%
  ungroup() %>%
  mutate(ipm_freq = (monthly_count / nr_tokens_in_mainst_corpus) * 1000000)

saveRDS(mainst_frequency_summary, "data/mainst_frequency_summary.rds")
```

# Graphs of Frequencies
## Whole corpus
```{r}
ggplot(frequency_summary_all, aes(x = date, y = ipm_freq, linetype = category)) +
  geom_line() +
  geom_vline(xintercept = as.numeric(key_dates[1:length(key_dates)]), linetype = 2, size = 0.15) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), vjust = -40, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), vjust = -20, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), vjust = -26, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), vjust = -31, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), vjust = -36, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), vjust = -25, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), vjust = -12, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), vjust = -23, size = 1.8, check_overlap = TRUE) +
  ylab("Occurrences per million words") +
  xlab(element_blank()) +
  # labs(title = "Relative Monthly Occurrences, Entire Corpus, January 2015-February 2023") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 10),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.background = element_rect(fill = NA),
        legend.text = element_text(size = 6, face = "bold"),
        legend.position = c(0.72, 0.8),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_linetype_discrete(limits = c("migration_term", "refugee_term"),
                          labels = c("Migration Terms","Refugee Terms")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 250, 25),
  labels = seq(0, 250, 25),
  limits = c(0, 250)
  ) 

ggsave("graphs/whole_corpus.png", device = "png",
       width = 1920, height = 1080, units = "px")
```

## Alt sub-corpus
```{r}
ggplot(alt_frequency_summary, aes(x = date, y = ipm_freq, linetype = category)) +
  geom_line() +
  geom_vline(xintercept = as.numeric(key_dates[1:length(key_dates)]), linetype = 2, size = 0.15) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), vjust = -40, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), vjust = -20, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), vjust = -26, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), vjust = -45, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), vjust = -60, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), vjust = -50, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), vjust = -30, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), vjust = -25, size = 1.8, check_overlap = TRUE) +
  ylab("Occurrences per million words") +
  xlab(element_blank()) +
  # labs(title = "Relative Monthly Occurrences, Alternative Media, January 2015-February 2023") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.text = element_text(size = 6, face = "bold"),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.72, 0.8),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_linetype_discrete(limits = c("migration_term", "refugee_term"),
                          labels = c("Migration Terms","Refugee Terms")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 250, 25),
  labels = seq(0, 250, 25),
  limits = c(0, 250)
  ) 

ggsave("graphs/alt_corpus.png", device = "png",
       width = 1920, height = 1080, units = "px")
```

## Mainstream sub-corpus
```{r}
# Mainstream sub-corpus
ggplot(mainst_frequency_summary, aes(x = date, y = ipm_freq, linetype = category)) +
  geom_line() +
  geom_vline(xintercept = as.numeric(key_dates[1:length(key_dates)]), linetype = 2, size = 0.15) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), vjust = -29, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), vjust = -48, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), vjust = -20, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), vjust = -26, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), vjust = -31, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), vjust = -36, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), vjust = -25, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), vjust = -12, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), vjust = -23, size = 1.8, check_overlap = TRUE) +
  ylab("Occurrences per million words") +
  xlab(element_blank()) +
  # labs(title = "Relative Monthly Occurrences, Mainstream Media, January 2015-February 2023") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.text = element_text(size = 6, face = "bold"),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.72, 0.8),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_linetype_discrete(limits = c("migration_term", "refugee_term"),
                          labels = c("Migration Terms","Refugee Terms")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 250, 25),
  labels = seq(0, 250, 25),
  limits = c(0, 250)
  ) 

ggsave("graphs/mainst_corpus.png", device = "png",
       width = 1920, height = 1080, units = "px")
```

## Combined Alternative and Mainstream Graph
```{r}
alt_frequency_summary$media_type <- "Alternative Media"
mainst_frequency_summary$media_type <- "Mainstream Media"

# B&W graph for publication
alt_frequency_summary %>% 
  bind_rows(mainst_frequency_summary) %>% 
  # unite("category_by_type", all_of(c("media_type", "category"))) %>% 
  ggplot(aes(x = date, y = ipm_freq, linetype = category)) +
  geom_line(size = 0.4) +
  facet_wrap(~ media_type, nrow = 2) +
  geom_vline(xintercept = as.numeric(key_dates[1:length(key_dates)]), linetype = 2, linewidth = 0.1) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), vjust = -17, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), vjust = -13, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), vjust = -6, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), vjust = -15, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), vjust = -19, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), vjust = -11, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), vjust = -5, size = 1.8, check_overlap = TRUE) +
  ylab("Occurrences per million words") +
  xlab(element_blank()) +
  # labs(title = "Relative Monthly Occurrences, Mainstream Media, January 2015-February 2023") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.text = element_text(size = 5, face = "bold"),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.93, 0.88),
        plot.margin = margin(7,10,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_linetype_discrete(limits = c("migration_term", "refugee_term"),
                          labels = c("Migration Terms","Refugee Terms")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 250, 25),
  labels = seq(0, 250, 25),
  limits = c(0, 250)
  ) 

ggsave("graphs/alt_and_mainst_corpus.png", device = "png",
       width = 1920, height = 1080, units = "px")
```


```{r}
# Color graph for presentation
alt_frequency_summary %>% 
  bind_rows(mainst_frequency_summary) %>% 
  ggplot(aes(x = date, y = ipm_freq)) +
  geom_line(aes(color = category), size = 0.4) +
  facet_wrap(~ media_type, nrow = 2) +
  geom_vline(xintercept = as.numeric(key_dates[1:length(key_dates)]), linetype = 2, linewidth = 0.1) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), vjust = -17, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), vjust = -13, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), vjust = -6, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), vjust = -15, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), vjust = -19, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), vjust = -22, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), vjust = -11, size = 1.8, check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), vjust = -5, size = 1.8, check_overlap = TRUE) +
  ylab("Occurrences per million words") +
  xlab(element_blank()) +
  labs(title = "Term frequencies by media type, January 2015-February 2023",
       subtitle = "Relative monthly occurences of migration & refugee terms, aggregated by month and split by media type",
       caption = "Data: Newton Media Archive, Media types: Vaclav Cvrcek & Jan Henys (2023)") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 4.5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.key = element_blank(),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.73, 0.91),
        plot.margin = margin(7,30,3,5, "pt"))  +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_color_discrete(limits = c("migration_term", "refugee_term"),
                          labels = c("Migration Terms","Refugee Terms")) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 250, 25),
  labels = seq(0, 250, 25),
  limits = c(0, 250)
  ) 

ggsave("../../5.write_up/conference_bratislava_october_2023/graphics/term_frequencies_by_media_type.png", device = "png",
       width = 1920, height = 1080, units = "px")
```


# X Word frequencies using text from Regex processed dataset
## X.1 Process data
```{r}
regex_files_path <- "../../2.data_transformations/media_articles/data/regex_processed/chunks/"

# Load stop words
stop_words_cs <- c(fromJSON("../../2.data_transformations/media_articles/data/irene_stopwords.json"),
                   fromJSON("../../2.data_transformations/media_articles/data/stopwords_cs.json")) %>%
                   unique()

# Load regex-processed dataset of full texts
period_dataset <-
    list.files(path = regex_files_path,
               pattern = "*.rds",
               full.names = TRUE) %>%
    map_dfr(readRDS) %>% 
    distinct() %>%
    mutate(text = map_chr(str_extract_all(text, pattern = regex_pattern), ~ str_c(.x, collapse=" ")))
    
# With data.table (more memory efficient)
period_dataset[, text := str_extract_all(text, pattern = regex_pattern)][, text := map_chr(text, ~ str_c(.x, collapse=" "))]
period_dataset <- distinct(period_dataset)

saveRDS(period_dataset, "data/key_words_per_doc.rds")

# Process corpus to create a DFM
period_corpus <- corpus(period_dataset,
         docid_field = "article_id",
         text_field = "text")

rm(period_dataset)
gc()

period_corpus_tokenized <- period_corpus %>%
  tokens(
    remove_punct = TRUE,
    remove_numbers = TRUE,
    remove_symbols = TRUE,
    remove_url = TRUE
  ) %>%
  tokens_tolower() %>%
  tokens_remove(pattern = stop_words_cs) # Filter out our stopwords

rm(period_corpus)
gc()

period_dfm <- period_corpus_tokenized %>%
  dfm() %>%
  .[, grepl(regex_pattern, colnames(.))] %>% # Filter only columns relevant to the regex string
  dfm_trim(min_termfreq = 20) %>% # Filter only terms that appear at least x times
  as.matrix()

rm(period_corpus_tokenized)
gc()

saveRDS(period_dfm, "data/all_media_dfm.rds")

# Which of our searched words were the most common
most_common_terms <- colSums(period_dfm) %>%
  sort(decreasing = TRUE) %>%
  .[nchar(names(.)) > 1]

```

```{r}
# A workaround to have lemmatized word frequencies, before we use the full
# UDPIPE data 2015-present
source("../../2.data_transformations/media_articles/udpipe_api_process.R")

lemmatized_migration_terms <-
  udpipe_process(
    article_id = as.character(most_common_terms),
    article_text = names(most_common_terms),
    log = TRUE
  ) %>%
  transmute(token,
            lemma,
            upos,
            total_count = as.integer(doc_id)) %>% 
 filter(nchar(token) > 1)

saveRDS(lemmatized_migration_terms, "data/lemmatized_migration_terms.rds")

```

# Outdated workflow
```{r}
terms_lemma <- readRDS("data/lemmatized_migration_terms.rds")
doc_id_by_date <- readRDS("data/doc_id_by_date.rds")
filtered_terms <- terms_lemma[terms_lemma$total_count > 100 & terms_lemma$upos %in% c("NOUN", "VERB"), "token"]

# Graph zoom date end & beginning
start_date <- as.Date("2015-01-01")
end_date <- as.Date("2022-04-30")

period_frequency_df <- readRDS("data/all_media_dfm.rds") %>%
  as_tibble(rownames = "doc_id") %>%
  select(doc_id, all_of(filtered_terms)) %>%
  inner_join(doc_id_by_date, by = "doc_id") %>%
  mutate(date = as.Date(cut(date, "months"))) %>% 
  filter(date < as.Date("2022-05-01"))

recoded_factor <- c(
  "refugee_terms" = "azylant",
  "refugee_terms" = "azylantov",
  "refugee_terms" = "běženec",
  "refugee_terms" = "běženkyně",
  "migration_terms" = "imigrace",
  "migration_terms" = "imigrant",
  "migration_terms" = "imigranta",
  "migration_terms" = "imigrantek",
  "migration_terms" = "imigrantka",
  "migration_terms" = "imigrantom",
  "migration_terms" = "imigrantov",
  "migration_terms" = "migrace",
  "migration_terms" = "migracni",
  NULL = "migraine",
  NULL = "migrans",
  "migration_terms" = "migrant",
  "migration_terms" = "migranta",
  NULL = "migranten",
  NULL = "migrantes",
  "migration_terms" = "migrantka",
  "migration_terms" = "migrantoch",
  "migration_terms" = "migrantom",
  "migration_terms" = "migrantov",
  NULL = "migrantów",
  "migration_terms" = "migrantum",
  NULL = "migrastatika",
  NULL = "migrat",
  NULL = "migrate",
  NULL = "migrated",
  NULL = "migrating",
  NULL = "migration",
  NULL = "migrator",
  "migration_terms" = "přistěhovalec",
  "migration_terms" = "přistěhovalectví",
  "migration_terms" = "přistěhovalkyně",
  "migration_terms" = "přistěhovat",
  "refugee_terms" = "uprchlic",
  "refugee_terms" = "uprchlice",
  "refugee_terms" = "uprchlickich",
  "refugee_terms" = "uprchlictví",
  "refugee_terms" = "uprchlik",
  "refugee_terms" = "uprchlík",
  "refugee_terms" = "uprchlika",
  "refugee_terms" = "uprchlíka",
  "refugee_terms" = "uprchlikum",
  "refugee_terms" = "uprchnout",
  "refugee_terms" = "utečenca",
  "refugee_terms" = "utečencoch",
  "refugee_terms" = "utečencom",
  "refugee_terms" = "utečencov",
  "refugee_terms" = "utečenec"
)

key_dates <- setNames(c(as.Date("2015-05-11"),
                        as.Date("2015-09-02"),
                        as.Date("2016-09-21"),
                        as.Date("2016-11-03"),
                        as.Date("2018-01-27"),
                        as.Date("2018-06-10"),
                        as.Date("2019-01-01"),
                        as.Date("2020-03-11"),
                        as.Date("2022-02-24")),
                      c("EU quota",
                        "Alan Kurdi",
                        "Egypt shipwreck",
                        "Libya shipwreck",
                        "Milos Zeman re-elected",
                        "Aquarius rejected",
                        "Lowest 5yr arrivals",
                        "Pandemic start",
                        "Invasion of Ukraine"))

```

```{r}
frequency_summary_all <- period_frequency_df %>%
  select(-any_of(colnames(media_labels))) %>%
  pivot_longer(cols = filtered_terms,
               names_to = "term",
               values_to = "count") %>%
  inner_join(terms_lemma, by = c("term" = "token")) %>%
  mutate(
    lemma = fct_recode(lemma, !!!recoded_factor)
  ) %>%
  filter(!is.na(lemma)) %>% 
  group_by(date, lemma) %>%
  summarize(monthly_count = sum(count))

frequency_summary_mainstream <- period_frequency_df %>%
  inner_join(media_labels, by = "doc_id") %>% 
  filter(media_type %in% c("mainstream")) %>% 
  select(-any_of(colnames(media_labels))) %>%
  pivot_longer(cols = filtered_terms,
               names_to = "term",
               values_to = "count") %>%
  inner_join(terms_lemma, by = c("term" = "token")) %>%
   mutate(
    lemma = fct_recode(
      lemma, !!!recoded_factor)
  ) %>%
  filter(!is.na(lemma)) %>% 
  group_by(date, lemma) %>%
  summarize(monthly_count = sum(count))

frequency_summary_alt <- period_frequency_df %>%
  inner_join(media_labels, by = "doc_id") %>% 
  filter(media_type %in% c("antisystem", "political_tabloid")) %>% 
  select(-any_of(colnames(media_labels))) %>%
  pivot_longer(cols = filtered_terms,
               names_to = "term",
               values_to = "count") %>%
  inner_join(terms_lemma, by = c("term" = "token")) %>%
    mutate(
    lemma = fct_recode(
      lemma, !!!recoded_factor)
  ) %>%
  filter(!is.na(lemma)) %>% 
  group_by(date, lemma) %>%
  summarize(monthly_count = sum(count))
```

```{r}
# Graphs with lemma categories related to migration by media type
# Mainstream
ggplot(frequency_summary_mainstream, aes(x = date, y = monthly_count/1000, color = lemma)) +
  geom_line() +
  geom_point(size = 0.3) +
  scale_color_manual(values = c("refugee_terms" = "#2b9bf4", "migration_terms" = "#db1d0b"), labels = c("refugee_terms" = "Refugee terms", "migration_terms" = "Migration terms")) + 
  geom_vline(xintercept = c(as.numeric(key_dates[1:length(key_dates)])), color = "#563a3a", linetype = 2, size = 0.2) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), color = "#22209F", vjust = -22, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), color = "#22209F", vjust = -40, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), color = "#22209F", vjust = -20, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), color = "#22209F", vjust = -26, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), color = "#22209F", vjust = -21, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), color = "#22209F", vjust = -26, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), color = "#22209F", vjust = -15, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), color = "#22209F", vjust = -12, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), color = "#22209F", vjust = -52, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  ylab("Term occurences (in thousand)") +
  xlab(element_blank()) +
  labs(title = "How do Czech Mainstream Media Communicate Migration?",
       subtitle = "Total monthly occurences of migration-related terms, 2015-2022",
       caption = "Data: Newton Media Archive, Vaclav Cvrcek & Jan Henys (2022)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.key = element_rect(fill = NA, size = 8),
        legend.text = element_text(size = 9),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.8, 0.9),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 100, 5),
  labels = seq(0, 100, 5),
  limits = c(0, max(frequency_summary_mainstream$monthly_count/1000) + 10)
  )

ggsave("../../5.write_up/presentation_CCL_march_2022/graphics/frequencies_terms_mainstream.png", device = "png",
       width = 1920, height = 1080, units = "px")

# Alternative
ggplot(frequency_summary_alt, aes(x = date, y = monthly_count/1000, color = lemma)) +
  geom_line() +
  geom_point(size = 0.3) +
  scale_color_manual(values = c("refugee_terms" = "#2b9bf4", "migration_terms" = "#db1d0b"), labels = c("refugee_terms" = "Refugee terms", "migration_terms" = "Migration terms")) +
  geom_vline(xintercept = c(as.numeric(key_dates[1:length(key_dates)])), color = "#563a3a", linetype = 2, size = 0.2) +
  geom_text(aes(x = key_dates[1], y = 0, label = names(key_dates)[1]), color = "#22209F", vjust = -35, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[2], y = 0, label = names(key_dates)[2]), color = "#22209F", vjust = -45, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[3], y = 0, label = names(key_dates)[3]), color = "#22209F", vjust = -30, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[4], y = 0, label = names(key_dates)[4]), color = "#22209F", vjust = -25, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[5], y = 0, label = names(key_dates)[5]), color = "#22209F", vjust = -35, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[6], y = 0, label = names(key_dates)[6]), color = "#22209F", vjust = -45, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[7], y = 0, label = names(key_dates)[7]), color = "#22209F", vjust = -40, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[8], y = 0, label = names(key_dates)[8]), color = "#22209F", vjust = -30, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  geom_text(aes(x = key_dates[9], y = 0, label = names(key_dates)[9]), color = "#22209F", vjust = -17, size = 1.5, fontface = "bold", check_overlap = TRUE) +
  ylab("Term occurences (in thousand)") +
  xlab(element_blank()) +
  labs(title = "How do Czech Alternative Media Communicate Migration?",
       subtitle = "Total monthly occurences of migration-related terms, 2015-2022",
       caption = "Data: Newton Media Archive, Vaclav Cvrcek & Jan Henys (2022)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 7),
        plot.background = element_rect(fill = "grey90"),
        plot.title = element_text(face = "bold", size = 10),
        plot.subtitle = element_text(face = "italic", size = 8),
        plot.caption = element_text(size = 5),
        axis.title.y = element_text(size = 8),
        legend.title = element_blank(),
        legend.key = element_rect(fill = NA, size = 8),
        legend.text = element_text(size = 9),
        legend.background = element_rect(fill = NA),
        legend.position = c(0.8, 0.9),
        plot.margin = margin(7,30,3,5, "pt")) +
  scale_x_date(date_breaks = "6 months", date_labels = "%m-%y") +
  coord_cartesian(xlim = c(start_date, end_date + 120), expand = FALSE) +
  scale_y_continuous(
  expand = c(0, 0),
  breaks = seq(0, 100, 5),
  labels = seq(0, 100, 5),
  limits = c(0, max(frequency_summary_alt$monthly_count/1000) + 10)
  )

ggsave("../../5.write_up/presentation_CCL_march_2022/graphics/frequencies_terms_alternative.png", device = "png",
       width = 1920, height = 1080, units = "px")

```

```{r}
# media_count_panel <- media_count_df_by_1_month %>% 
#   mutate(media_id = as.integer(id)) %>%
#   inner_join(distinct(all_media_labels_with_doc_id, media_id, .keep_all = TRUE),
#              by = "media_id") %>%
#   transmute(month = as.Date(period_start),
#             media_type,
#             count) %>% 
#   filter(media_type %in% c("mainstream", "antisystem", "tabloid", "political_tabloid", "opinion", "market_driven")) %>% 
#   group_by(month, media_type) %>% 
#   summarise(count = sum(count)) %>% 
#   ungroup() %>% 
#   pdata.frame(index = c("media_type", "month"))
```

